<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSApp Modernization - Technical Addendum</title>
    <style>
        :root {
            --gov-blue: #003366;
            --gov-gold: #FCBA19;
            --success-green: #2E8540;
            --warning-orange: #F8991D;
            --danger-red: #D8292F;
            --light-bg: #F2F2F2;
            --text-primary: #313132;
            --code-bg: #1e1e1e;
            --code-text: #d4d4d4;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'BC Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #fff;
        }

        header {
            background: var(--gov-blue);
            color: white;
            padding: 30px 40px;
            margin: -20px -20px 30px -20px;
            border-bottom: 4px solid var(--gov-gold);
        }

        header h1 {
            margin: 0 0 10px 0;
            font-size: 2em;
            font-weight: 700;
        }

        header .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        header .badge {
            display: inline-block;
            background: var(--gov-gold);
            color: var(--gov-blue);
            padding: 5px 15px;
            border-radius: 4px;
            font-weight: 600;
            margin-top: 15px;
        }

        .toc {
            background: var(--light-bg);
            padding: 25px 30px;
            border-radius: 8px;
            margin-bottom: 35px;
        }

        .toc h2 {
            margin-top: 0;
            color: var(--gov-blue);
        }

        .toc ol {
            columns: 2;
            column-gap: 40px;
        }

        .toc li {
            margin-bottom: 8px;
        }

        .toc a {
            color: var(--gov-blue);
            text-decoration: none;
        }

        .toc a:hover {
            text-decoration: underline;
        }

        h2 {
            color: var(--gov-blue);
            border-bottom: 2px solid var(--gov-gold);
            padding-bottom: 10px;
            margin-top: 45px;
        }

        h3 {
            color: var(--gov-blue);
            margin-top: 30px;
        }

        h4 {
            color: #444;
            margin-top: 20px;
        }

        .section {
            margin-bottom: 40px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.95em;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: var(--gov-blue);
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background: #f8f9fa;
        }

        code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
        }

        pre {
            background: var(--code-bg);
            color: var(--code-text);
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }

        pre code {
            background: none;
            padding: 0;
            color: inherit;
        }

        .keyword { color: #569cd6; }
        .string { color: #ce9178; }
        .comment { color: #6a9955; }
        .function { color: #dcdcaa; }
        .number { color: #b5cea8; }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin: 25px 0;
        }

        .comparison-card {
            background: var(--light-bg);
            border-radius: 8px;
            padding: 25px;
        }

        .comparison-card h4 {
            margin-top: 0;
            color: var(--gov-blue);
            border-bottom: 2px solid var(--gov-gold);
            padding-bottom: 8px;
        }

        .comparison-card.bad {
            border-left: 4px solid var(--danger-red);
        }

        .comparison-card.good {
            border-left: 4px solid var(--success-green);
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .metric-card {
            background: linear-gradient(135deg, var(--gov-blue) 0%, #1a4d80 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-card .value {
            font-size: 2.5em;
            font-weight: 700;
        }

        .metric-card .label {
            opacity: 0.9;
            margin-top: 5px;
        }

        .benefit-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .benefit-item {
            background: #f8f9fa;
            border-left: 4px solid var(--success-green);
            padding: 20px;
            border-radius: 0 8px 8px 0;
        }

        .benefit-item h4 {
            margin-top: 0;
            color: var(--success-green);
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid var(--warning-orange);
            padding: 20px;
            border-radius: 0 8px 8px 0;
            margin: 20px 0;
        }

        .info-box {
            background: #cce5ff;
            border-left: 4px solid #004085;
            padding: 20px;
            border-radius: 0 8px 8px 0;
            margin: 20px 0;
        }

        .schema-diagram {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 30px;
            margin: 25px 0;
            overflow-x: auto;
        }

        .test-coverage {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }

        .coverage-bar {
            flex: 1;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
        }

        .coverage-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success-green) 0%, #3fa652 100%);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 15px;
            color: white;
            font-weight: 600;
        }

        .file-tree {
            background: var(--code-bg);
            color: var(--code-text);
            padding: 20px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            line-height: 1.8;
        }

        .file-tree .folder {
            color: #dcdcaa;
        }

        .file-tree .file {
            color: #9cdcfe;
        }

        .file-tree .indent {
            margin-left: 20px;
        }

        .security-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .security-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #dee2e6;
        }

        .security-item.implemented {
            border-left: 4px solid var(--success-green);
        }

        .security-item.partial {
            border-left: 4px solid var(--warning-orange);
        }

        .security-item.todo {
            border-left: 4px solid var(--danger-red);
        }

        .security-item h5 {
            margin: 0 0 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-dot.green { background: var(--success-green); }
        .status-dot.yellow { background: var(--warning-orange); }
        .status-dot.red { background: var(--danger-red); }

        footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 2px solid var(--gov-gold);
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .comparison-grid { grid-template-columns: 1fr; }
            .toc ol { columns: 1; }
        }

        @media print {
            body { max-width: 100%; }
            header { margin: 0 0 30px 0; }
            pre { white-space: pre-wrap; }
        }
    </style>
</head>
<body>
    <header>
        <h1>LSApp Modernization</h1>
        <div class="subtitle">Technical Addendum for Technical Leadership</div>
        <div class="badge">TECHNICAL DOCUMENT</div>
    </header>

    <nav class="toc">
        <h2>Table of Contents</h2>
        <ol>
            <li><a href="#sqlite">SQLite Architecture Benefits</a></li>
            <li><a href="#schema">Database Schema Design</a></li>
            <li><a href="#search">Full-Text Search Implementation</a></li>
            <li><a href="#testing">Testing Framework & Coverage</a></li>
            <li><a href="#logging">Logging Implementation</a></li>
            <li><a href="#security">Security Architecture</a></li>
            <li><a href="#import">Data Import Pipeline</a></li>
            <li><a href="#sync">ELM Sync System</a></li>
            <li><a href="#patterns">Code Patterns & Standards</a></li>
            <li><a href="#performance">Performance Considerations</a></li>
            <li><a href="#maintenance">Long-Term Maintenance</a></li>
            <li><a href="#cicd">CI/CD Integration</a></li>
        </ol>
    </nav>

    <section id="sqlite" class="section">
        <h2>1. SQLite Architecture Benefits</h2>

        <h3>1.1 Why SQLite Over CSV Files</h3>

        <div class="comparison-grid">
            <div class="comparison-card bad">
                <h4>Legacy: CSV Storage</h4>
                <ul>
                    <li>59 separate CSV files</li>
                    <li>Full file scan for every query (O(n))</li>
                    <li>No indexing capability</li>
                    <li>No referential integrity</li>
                    <li>Race conditions on concurrent writes</li>
                    <li>No transaction support</li>
                    <li>Manual relationship management</li>
                    <li>No query optimization</li>
                    <li>String-only data types</li>
                </ul>
            </div>
            <div class="comparison-card good">
                <h4>lsapp5000: SQLite</h4>
                <ul>
                    <li>Single database file (11.8 MB)</li>
                    <li>Indexed queries (O(log n) or O(1))</li>
                    <li>22 optimized indexes</li>
                    <li>Foreign key enforcement</li>
                    <li>ACID-compliant transactions</li>
                    <li>Full transaction support</li>
                    <li>Automatic cascade deletes</li>
                    <li>Query planner optimization</li>
                    <li>Strong typing with constraints</li>
                </ul>
            </div>
        </div>

        <h3>1.2 Why SQLite Over Client-Server Databases (MySQL, PostgreSQL)</h3>

        <div class="benefit-list">
            <div class="benefit-item">
                <h4>Zero Configuration</h4>
                <p>No server process, no connection strings, no ports, no authentication setup. The database is just a file.</p>
            </div>
            <div class="benefit-item">
                <h4>Zero Dependencies</h4>
                <p>SQLite is compiled into PHP (since PHP 5.3). No additional packages, extensions, or services required.</p>
            </div>
            <div class="benefit-item">
                <h4>Zero Maintenance</h4>
                <p>No database server to patch, upgrade, or monitor. No connection pool tuning. No memory allocation issues.</p>
            </div>
            <div class="benefit-item">
                <h4>Atomic Backup</h4>
                <p>Backup is simply copying a single file. Restore is replacing that file. No export/import complexity.</p>
            </div>
            <div class="benefit-item">
                <h4>Portable</h4>
                <p>Database moves with the application. Copy the folder, and you have a complete working system.</p>
            </div>
            <div class="benefit-item">
                <h4>Appropriate Scale</h4>
                <p>With ~300 courses, ~1000 classes, and ~100 users, SQLite handles this workload trivially. Client-server is overkill.</p>
            </div>
        </div>

        <div class="info-box">
            <strong>Performance Reality:</strong> SQLite can handle <strong>hundreds of thousands of reads per second</strong> and thousands of writes per second on modern hardware. LSApp's workload (administrative catalog management by a small team) is orders of magnitude below SQLite's capabilities.
        </div>

        <h3>1.3 SQLite Durability Features</h3>
        <table>
            <thead>
                <tr>
                    <th>Feature</th>
                    <th>Implementation</th>
                    <th>Benefit</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Write-Ahead Logging (WAL)</td>
                    <td>Optional (not currently enabled)</td>
                    <td>Improved concurrency, crash recovery</td>
                </tr>
                <tr>
                    <td>Foreign Keys</td>
                    <td><code>PRAGMA foreign_keys = ON</code></td>
                    <td>Referential integrity enforced</td>
                </tr>
                <tr>
                    <td>Transactions</td>
                    <td>BEGIN/COMMIT/ROLLBACK</td>
                    <td>All-or-nothing operations</td>
                </tr>
                <tr>
                    <td>Cascading Deletes</td>
                    <td><code>ON DELETE CASCADE</code></td>
                    <td>Automatic cleanup of related records</td>
                </tr>
                <tr>
                    <td>ACID Compliance</td>
                    <td>Built-in</td>
                    <td>Data consistency guaranteed</td>
                </tr>
            </tbody>
        </table>
    </section>

    <section id="schema" class="section">
        <h2>2. Database Schema Design</h2>

        <h3>2.1 Core Entity Relationships</h3>
        <div class="schema-diagram">
<pre>
                                    ┌─────────────────┐
                                    │     partners    │
                                    ├─────────────────┤
                                    │ id (PK)         │
                                    │ name            │
                                    │ slug            │
                                    │ description     │
                              ┌─────│ link            │
                              │     └─────────────────┘
                              │              │
                              │              │ 1:N
                              │              ▼
                              │     ┌─────────────────┐
                              │     │ partner_contacts│
                              │     ├─────────────────┤
                              │     │ id (PK)         │
                              │     │ partner_id (FK) │───────┐
                              │     │ IDIR            │       │
                              │     │ email           │       │
                              │     │ name, title     │       │
                              │     └─────────────────┘       │
                              │                               │
                              │                               │
┌─────────────────┐           │     ┌─────────────────┐       │
│     people      │           │     │     courses     │◄──────┘
├─────────────────┤           │     ├─────────────────┤
│ IDIR (PK)       │◄──────────┼─────│ CourseID (PK)   │
│ FirstName       │           │     │ CourseName      │
│ LastName        │           │     │ Status          │
│ Role            │           │     │ LearningHub     │
│ Title           │           └────►│   Partner (FK)  │
│ Super (admin)   │                 │ topic_id (FK)   │────────┐
│ Color           │                 │ audience_id(FK) │────────┼─┐
└─────────────────┘                 │ delivery_method │────────┼─┼─┐
        │                           │   _id (FK)      │        │ │ │
        │                           └─────────────────┘        │ │ │
        │                                   │                  │ │ │
        │ N:M (via courses_people)          │ 1:N              │ │ │
        │                                   ▼                  │ │ │
        │                           ┌─────────────────┐        │ │ │
        └──────────────────────────►│ courses_people  │        │ │ │
                                    ├─────────────────┤        │ │ │
                                    │ CourseID (FK)   │        │ │ │
                                    │ IDIR (FK)       │        │ │ │
                                    │ Role            │        │ │ │
                                    │ Date            │        │ │ │
                                    └─────────────────┘        │ │ │
                                                               │ │ │
┌─────────────────┐     ┌─────────────────┐                    │ │ │
│     venues      │◄────│     classes     │                    │ │ │
├─────────────────┤     ├─────────────────┤     ┌──────────────┘ │ │
│ VenueID (PK)    │     │ ClassID (PK)    │     │                │ │
│ VenueName       │     │ CourseID (FK)   │◄────┼────────────────┘ │
│ Address         │     │ VenueID (FK)    │     │                  │
│ City            │     │ StartDate       │     ▼                  │
│ Contact         │     │ EndDate         │ ┌─────────────────┐    │
│ Region          │     │ Status          │ │     topics      │    │
└─────────────────┘     │ Enrolled        │ ├─────────────────┤    │
                        │ Waitlisted      │ │ id (PK)         │    │
                        └─────────────────┘ │ name            │    │
                                │           │ display_order   │    │
                                │           └─────────────────┘    │
                                │ 1:N                              │
                                ▼           ┌─────────────────┐    │
                        ┌─────────────────┐ │    audiences    │◄───┘
                        │  classes_notes  │ ├─────────────────┤
                        ├─────────────────┤ │ id (PK)         │
                        │ NoteID (PK)     │ │ name            │
                        │ ClassID (FK)    │ │ display_order   │
                        │ Date            │ └─────────────────┘
                        │ NotedBy         │
                        │ Note            │ ┌──────────────────┐
                        └─────────────────┘ │ delivery_methods │
                                            ├──────────────────┤
                                            │ id (PK)          │
                                            │ name             │
                                            │ display_order    │
                                            └──────────────────┘
</pre>
        </div>

        <h3>2.2 Change Request Schema</h3>
        <div class="schema-diagram">
<pre>
┌───────────────────────────┐
│     courses_changes       │
├───────────────────────────┤
│ changeid (PK)             │
│ courseid (FK → courses)   │
│ category                  │
│ description               │
│ scope (Minor/Mod/Major)   │
│ urgent (0/1)              │
│ progress                  │
│ approval_status           │
│ assign_to                 │
│ crm_ticket_reference      │
│ date_created              │
│ date_modified             │
│ created_by                │
│ modified_by               │
└───────────────────────────┘
            │
            │ 1:N (ON DELETE CASCADE)
            ├────────────────────────────────────────┐
            │                                        │
            ▼                                        ▼
┌───────────────────────────┐       ┌───────────────────────────┐
│ courses_changes_timeline  │       │ courses_changes_comments  │
├───────────────────────────┤       ├───────────────────────────┤
│ id (PK)                   │       │ id (PK)                   │
│ changeid (FK)             │       │ changeid (FK)             │
│ field_name                │       │ comment                   │
│ old_value                 │       │ created_by                │
│ new_value                 │       │ created_at                │
│ changed_by                │       └───────────────────────────┘
│ changed_at                │
└───────────────────────────┘
            │
            │ 1:N
            ├────────────────────────────────────────┐
            ▼                                        ▼
┌───────────────────────────┐       ┌───────────────────────────┐
│  courses_changes_files    │       │  courses_changes_links    │
├───────────────────────────┤       ├───────────────────────────┤
│ id (PK)                   │       │ id (PK)                   │
│ changeid (FK)             │       │ changeid (FK)             │
│ original_filename         │       │ url                       │
│ stored_filename           │       │ description               │
│ uploaded_by               │       │ added_by                  │
│ uploaded_at               │       │ added_at                  │
└───────────────────────────┘       └───────────────────────────┘
</pre>
        </div>

        <h3>2.3 Index Strategy</h3>
        <table>
            <thead>
                <tr>
                    <th>Index Name</th>
                    <th>Table.Column(s)</th>
                    <th>Purpose</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>idx_classes_courseid</td>
                    <td>classes.CourseID</td>
                    <td>Fast lookup of classes for a course</td>
                </tr>
                <tr>
                    <td>idx_classes_venueid</td>
                    <td>classes.VenueID</td>
                    <td>Venue availability queries</td>
                </tr>
                <tr>
                    <td>idx_classes_startdate</td>
                    <td>classes.StartDate</td>
                    <td>Date range queries, upcoming classes</td>
                </tr>
                <tr>
                    <td>idx_courses_status</td>
                    <td>courses.Status</td>
                    <td>Filter by Active/Inactive/Deleted</td>
                </tr>
                <tr>
                    <td>idx_courses_topic</td>
                    <td>courses.topic_id</td>
                    <td>Topic filtering</td>
                </tr>
                <tr>
                    <td>idx_courses_partner</td>
                    <td>courses.LearningHubPartner</td>
                    <td>Partner-based queries</td>
                </tr>
                <tr>
                    <td>idx_courses_people_*</td>
                    <td>courses_people (multiple)</td>
                    <td>Instructor/role lookups</td>
                </tr>
                <tr>
                    <td>idx_changes_courseid</td>
                    <td>courses_changes.courseid</td>
                    <td>Change request history per course</td>
                </tr>
                <tr>
                    <td colspan="3"><em>+ 14 additional indexes for other foreign keys and common query patterns</em></td>
                </tr>
            </tbody>
        </table>
    </section>

    <section id="search" class="section">
        <h2>3. Full-Text Search Implementation</h2>

        <h3>3.1 FTS5 Virtual Table</h3>
        <p>lsapp5000 uses SQLite's FTS5 (Full-Text Search 5) extension for course searching:</p>

        <pre><code><span class="keyword">CREATE VIRTUAL TABLE</span> courses_fts <span class="keyword">USING</span> fts5(
    CourseID,
    CourseName,
    CourseShort,
    CourseDescription,
    CourseAbstract,
    Topics,
    Audience,
    Keywords,
    Prerequisites,
    <span class="keyword">content</span>=<span class="string">'courses'</span>,
    <span class="keyword">content_rowid</span>=<span class="string">'rowid'</span>
);</code></pre>

        <h3>3.2 BM25 Ranking Algorithm</h3>
        <p>Search results are ranked using the BM25 algorithm, which considers:</p>
        <ul>
            <li><strong>Term Frequency:</strong> How often the search term appears in the document</li>
            <li><strong>Inverse Document Frequency:</strong> Rare terms weighted higher than common ones</li>
            <li><strong>Document Length:</strong> Normalized for fair comparison across varying lengths</li>
        </ul>

        <pre><code><span class="keyword">SELECT</span> c.*, bm25(courses_fts) <span class="keyword">AS</span> rank
<span class="keyword">FROM</span> courses_fts
<span class="keyword">JOIN</span> courses c <span class="keyword">ON</span> courses_fts.CourseID = c.CourseID
<span class="keyword">WHERE</span> courses_fts <span class="keyword">MATCH</span> <span class="string">?</span>
<span class="keyword">ORDER BY</span> rank;</code></pre>

        <h3>3.3 Auto-Sync Triggers</h3>
        <p>The FTS index stays synchronized with the courses table via triggers:</p>
        <pre><code><span class="comment">-- Insert trigger</span>
<span class="keyword">CREATE TRIGGER</span> courses_ai <span class="keyword">AFTER INSERT ON</span> courses <span class="keyword">BEGIN</span>
    <span class="keyword">INSERT INTO</span> courses_fts(rowid, CourseID, CourseName, ...)
    <span class="keyword">VALUES</span> (new.rowid, new.CourseID, new.CourseName, ...);
<span class="keyword">END</span>;

<span class="comment">-- Update and Delete triggers also defined</span></code></pre>
    </section>

    <section id="testing" class="section">
        <h2>4. Testing Framework & Coverage</h2>

        <h3>4.1 Test Infrastructure</h3>
        <div class="metric-grid">
            <div class="metric-card">
                <div class="value">PHPUnit 10.5</div>
                <div class="label">Testing Framework</div>
            </div>
            <div class="metric-card">
                <div class="value">4</div>
                <div class="label">Test Files</div>
            </div>
            <div class="metric-card">
                <div class="value">In-Memory</div>
                <div class="label">Test Database</div>
            </div>
            <div class="metric-card">
                <div class="value">CI/CD</div>
                <div class="label">GitHub Actions</div>
            </div>
        </div>

        <h3>4.2 Test Structure</h3>
        <div class="file-tree">
            <span class="folder">tests/</span><br>
            <span class="indent"><span class="file">bootstrap.php</span> - Test setup, DB initialization</span><br>
            <span class="indent"><span class="file">TestCase.php</span> - Base class with setUp/tearDown</span><br>
            <span class="indent"><span class="file">setup.sql</span> - Schema creation script</span><br>
            <span class="indent"><span class="folder">fixtures/</span></span><br>
            <span class="indent"><span class="indent"><span class="file">basic_data.sql</span> - Test data fixtures</span></span><br>
            <span class="indent"><span class="folder">Unit/</span></span><br>
            <span class="indent"><span class="indent"><span class="file">DatabaseConnectionTest.php</span></span></span><br>
            <span class="indent"><span class="indent"><span class="file">CsvImportTest.php</span></span></span><br>
            <span class="indent"><span class="indent"><span class="file">CrudOperationsTest.php</span></span></span><br>
            <span class="indent"><span class="folder">Integration/</span></span><br>
            <span class="indent"><span class="indent"><span class="file">PageRenderingTest.php</span></span></span>
        </div>

        <h3>4.3 Test Categories</h3>
        <table>
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Test File</th>
                    <th>Coverage Areas</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Database</td>
                    <td>DatabaseConnectionTest.php</td>
                    <td>PDO setup, FK enforcement, table existence, special characters</td>
                </tr>
                <tr>
                    <td>Import</td>
                    <td>CsvImportTest.php</td>
                    <td>Header parsing, multi-table imports, empty files, quoted values</td>
                </tr>
                <tr>
                    <td>CRUD</td>
                    <td>CrudOperationsTest.php</td>
                    <td>Create, Read, Update, Delete, FK validation, transactions</td>
                </tr>
                <tr>
                    <td>Integration</td>
                    <td>PageRenderingTest.php</td>
                    <td>Query execution, FTS5 search, pagination, filtering, statistics</td>
                </tr>
            </tbody>
        </table>

        <h3>4.4 Running Tests</h3>
        <pre><code><span class="comment"># Run all tests</span>
./run-tests.sh

<span class="comment"># Run with HTML coverage report</span>
./run-tests.sh --coverage

<span class="comment"># Run only unit tests</span>
./run-tests.sh --unit

<span class="comment"># Via Composer</span>
composer test</code></pre>

        <h3>4.5 CI/CD Pipeline</h3>
        <pre><code><span class="comment"># .github/workflows/tests.yml</span>
<span class="keyword">name</span>: Tests
<span class="keyword">on</span>:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

<span class="keyword">jobs</span>:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: [<span class="string">'8.2'</span>, <span class="string">'8.3'</span>, <span class="string">'8.4'</span>]
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
      - run: composer install
      - run: composer test</code></pre>
    </section>

    <section id="logging" class="section">
        <h2>5. Logging Implementation</h2>

        <h3>5.1 Multi-Layer Logging Strategy</h3>

        <table>
            <thead>
                <tr>
                    <th>Log Type</th>
                    <th>Storage</th>
                    <th>Purpose</th>
                    <th>Retention</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Sync Operations</td>
                    <td>Text files (sync/sync_log_*.txt)</td>
                    <td>Detailed per-course sync results</td>
                    <td>Indefinite (manual cleanup)</td>
                </tr>
                <tr>
                    <td>Sync Runs</td>
                    <td>Database (sync_runs table)</td>
                    <td>Queryable sync history</td>
                    <td>Indefinite</td>
                </tr>
                <tr>
                    <td>Course Changes</td>
                    <td>Database (course_changes table)</td>
                    <td>Field-level change tracking</td>
                    <td>Indefinite</td>
                </tr>
                <tr>
                    <td>User Actions</td>
                    <td>Database (timeline tables)</td>
                    <td>Who changed what, when</td>
                    <td>Indefinite</td>
                </tr>
                <tr>
                    <td>PHP Errors</td>
                    <td>Server error_log</td>
                    <td>Application errors, debugging</td>
                    <td>Per server config</td>
                </tr>
            </tbody>
        </table>

        <h3>5.2 Database Logging Schema</h3>
        <pre><code><span class="keyword">CREATE TABLE</span> sync_runs (
    id <span class="keyword">INTEGER PRIMARY KEY</span>,
    run_timestamp <span class="keyword">TEXT NOT NULL</span>,
    status <span class="keyword">TEXT</span>,
    courses_processed <span class="keyword">INTEGER DEFAULT</span> <span class="number">0</span>,
    courses_new <span class="keyword">INTEGER DEFAULT</span> <span class="number">0</span>,
    courses_updated <span class="keyword">INTEGER DEFAULT</span> <span class="number">0</span>,
    courses_deactivated <span class="keyword">INTEGER DEFAULT</span> <span class="number">0</span>,
    log_file <span class="keyword">TEXT</span>
);

<span class="keyword">CREATE TABLE</span> course_changes (
    id <span class="keyword">INTEGER PRIMARY KEY</span>,
    sync_run_id <span class="keyword">INTEGER</span>,
    course_id <span class="keyword">TEXT</span>,
    change_type <span class="keyword">TEXT</span>, <span class="comment">-- new, updated, reactivated, removed_from_hub, persisted_inactive</span>
    field_name <span class="keyword">TEXT</span>,
    old_value <span class="keyword">TEXT</span>,
    new_value <span class="keyword">TEXT</span>,
    changed_at <span class="keyword">TEXT</span>,
    <span class="keyword">FOREIGN KEY</span> (sync_run_id) <span class="keyword">REFERENCES</span> sync_runs(id)
);</code></pre>

        <h3>5.3 Change Request Audit Trail</h3>
        <p>Every modification to a change request is tracked in the timeline table:</p>
        <pre><code><span class="keyword">INSERT INTO</span> courses_changes_timeline
    (changeid, field_name, old_value, new_value, changed_by, changed_at)
<span class="keyword">VALUES</span>
    (<span class="number">123</span>, <span class="string">'progress'</span>, <span class="string">'pending'</span>, <span class="string">'in_progress'</span>, <span class="string">'ahaggett'</span>, <span class="string">'2026-01-09 14:30:00'</span>);</code></pre>

        <h3>5.4 Sync History UI</h3>
        <p>The <code>sync_history.php</code> page provides a queryable interface for reviewing:</p>
        <ul>
            <li>All sync operations with timestamps</li>
            <li>Per-course changes with old/new values</li>
            <li>Change type filtering</li>
            <li>Links to detailed text logs</li>
        </ul>
    </section>

    <section id="security" class="section">
        <h2>6. Security Architecture</h2>

        <h3>6.1 Security Implementation Status</h3>

        <div class="security-grid">
            <div class="security-item implemented">
                <h5>CSRF Protection <span class="status-dot green"></span></h5>
                <p>All forms and AJAX calls protected with session tokens. Uses <code>random_bytes(32)</code> and <code>hash_equals()</code> for timing-safe comparison.</p>
            </div>
            <div class="security-item implemented">
                <h5>SQL Injection Prevention <span class="status-dot green"></span></h5>
                <p>All database queries use PDO prepared statements with bound parameters. No string concatenation in queries.</p>
            </div>
            <div class="security-item implemented">
                <h5>Authentication <span class="status-dot green"></span></h5>
                <p>IDIR-based authentication via REMOTE_USER. Session caching for performance. Role-based access (user/super).</p>
            </div>
            <div class="security-item implemented">
                <h5>Password Hashing <span class="status-dot green"></span></h5>
                <p>Argon2ID with memory_cost: 65536, time_cost: 4, threads: 3 (legacy data encryption).</p>
            </div>
            <div class="security-item partial">
                <h5>XSS Prevention <span class="status-dot yellow"></span></h5>
                <p>htmlspecialchars() used but inconsistently. Needs systematic audit to ensure all user output is escaped.</p>
            </div>
            <div class="security-item partial">
                <h5>File Upload Validation <span class="status-dot yellow"></span></h5>
                <p>Basic handling exists but MIME type and extension validation should be strengthened.</p>
            </div>
            <div class="security-item todo">
                <h5>Security Headers <span class="status-dot red"></span></h5>
                <p>Missing: Content-Security-Policy, X-Frame-Options, X-Content-Type-Options.</p>
            </div>
            <div class="security-item todo">
                <h5>Session Timeout <span class="status-dot red"></span></h5>
                <p>Not currently configured. Should implement idle timeout for security.</p>
            </div>
        </div>

        <h3>6.2 CSRF Implementation Details</h3>
        <pre><code><span class="comment">// Generate token (stored in session)</span>
<span class="keyword">function</span> <span class="function">generateCSRFToken</span>(): <span class="keyword">string</span> {
    <span class="keyword">if</span> (!isset($_SESSION[<span class="string">'csrf_token'</span>])) {
        $_SESSION[<span class="string">'csrf_token'</span>] = bin2hex(random_bytes(<span class="number">32</span>));
    }
    <span class="keyword">return</span> $_SESSION[<span class="string">'csrf_token'</span>];
}

<span class="comment">// Verify token (timing-safe)</span>
<span class="keyword">function</span> <span class="function">verifyCSRFToken</span>(<span class="keyword">string</span> $token): <span class="keyword">bool</span> {
    <span class="keyword">return</span> isset($_SESSION[<span class="string">'csrf_token'</span>]) &&
           hash_equals($_SESSION[<span class="string">'csrf_token'</span>], $token);
}

<span class="comment">// JavaScript helper for AJAX</span>
<span class="keyword">async function</span> <span class="function">fetchWithCSRF</span>(url, options = {}) {
    options.headers = options.headers || {};
    options.headers[<span class="string">'X-CSRF-Token'</span>] = document.querySelector(
        <span class="string">'meta[name="csrf-token"]'</span>
    ).content;
    <span class="keyword">return</span> fetch(url, options);
}</code></pre>

        <h3>6.3 Security Audit Report</h3>
        <p>A comprehensive security audit was conducted (September 2025) with findings documented in <code>SECURITY_AUDIT_REPORT.md</code>. Key action items:</p>
        <ol>
            <li><strong>Priority 1:</strong> Complete XSS mitigation (apply htmlspecialchars consistently)</li>
            <li><strong>Priority 2:</strong> Add security headers (CSP, X-Frame-Options)</li>
            <li><strong>Priority 3:</strong> Implement session timeout</li>
            <li><strong>Priority 4:</strong> Strengthen file upload validation</li>
        </ol>
    </section>

    <section id="import" class="section">
        <h2>7. Data Import Pipeline</h2>

        <h3>7.1 Import Sources</h3>
        <table>
            <thead>
                <tr>
                    <th>Source</th>
                    <th>Format</th>
                    <th>Target Table(s)</th>
                    <th>Script</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Legacy People</td>
                    <td>CSV</td>
                    <td>people</td>
                    <td>import_csv_data.php</td>
                </tr>
                <tr>
                    <td>Legacy Venues</td>
                    <td>CSV</td>
                    <td>venues</td>
                    <td>import_csv_data.php</td>
                </tr>
                <tr>
                    <td>Legacy Courses</td>
                    <td>CSV</td>
                    <td>courses</td>
                    <td>import_csv_data.php</td>
                </tr>
                <tr>
                    <td>Legacy Classes</td>
                    <td>CSV</td>
                    <td>classes</td>
                    <td>import_csv_data.php</td>
                </tr>
                <tr>
                    <td>Partners</td>
                    <td>JSON</td>
                    <td>partners, partner_contacts</td>
                    <td>import_csv_data.php</td>
                </tr>
                <tr>
                    <td>Change Requests</td>
                    <td>JSON (106 files)</td>
                    <td>courses_changes + child tables</td>
                    <td>import_change_requests.php</td>
                </tr>
            </tbody>
        </table>

        <h3>7.2 Import Statistics</h3>
        <div class="metric-grid">
            <div class="metric-card">
                <div class="value">106</div>
                <div class="label">Change Requests Imported</div>
            </div>
            <div class="metric-card">
                <div class="value">638</div>
                <div class="label">Timeline Entries</div>
            </div>
            <div class="metric-card">
                <div class="value">15</div>
                <div class="label">File References</div>
            </div>
            <div class="metric-card">
                <div class="value">44</div>
                <div class="label">Related Links</div>
            </div>
        </div>

        <h3>7.3 Encoding Handling</h3>
        <p><code>clean_and_import.php</code> handles character encoding issues common in legacy CSV exports:</p>
        <pre><code><span class="comment">// Convert to UTF-8 if needed</span>
$encoding = mb_detect_encoding($line, [<span class="string">'UTF-8'</span>, <span class="string">'ISO-8859-1'</span>, <span class="string">'Windows-1252'</span>]);
<span class="keyword">if</span> ($encoding !== <span class="string">'UTF-8'</span>) {
    $line = mb_convert_encoding($line, <span class="string">'UTF-8'</span>, $encoding);
}

<span class="comment">// Remove BOM if present</span>
$line = preg_replace(<span class="string">'/^\xEF\xBB\xBF/'</span>, <span class="string">''</span>, $line);</code></pre>
    </section>

    <section id="sync" class="section">
        <h2>8. ELM Sync System</h2>

        <h3>8.1 Three-Stage Processing Pipeline</h3>
        <div class="comparison-grid">
            <div class="comparison-card good">
                <h4>Stage 1: Parse & Merge</h4>
                <p><strong>File:</strong> process.php</p>
                <ul>
                    <li>Parse external CSV feeds</li>
                    <li>Merge keywords with courses</li>
                    <li>Categorize metadata</li>
                    <li>Filter by Keyword Type ID 1039</li>
                </ul>
            </div>
            <div class="comparison-card good">
                <h4>Stage 2: Sync to Database</h4>
                <p><strong>File:</strong> elm-course-sync.php</p>
                <ul>
                    <li>Compare with existing courses</li>
                    <li>Insert new courses</li>
                    <li>Update changed fields</li>
                    <li>Handle deactivations</li>
                    <li>Log all changes</li>
                </ul>
            </div>
        </div>

        <h3>8.2 Sync Logic: Hub Persistence</h3>
        <div class="info-box">
            <strong>Key Design Decision:</strong> The sync system <em>never</em> deactivates courses. When a course is removed from the external feed:
            <ul>
                <li>If <code>HubIncludePersist = 'Yes'</code> → Course becomes "persisted_inactive" (visible but marked inactive)</li>
                <li>If <code>HubIncludePersist = 'No'</code> → Course is hidden from Hub (<code>HUBInclude = 'No'</code>) but Status remains Active</li>
            </ul>
            This prevents accidental data loss and maintains referential integrity.
        </div>

        <h3>8.3 Change Types Tracked</h3>
        <table>
            <thead>
                <tr>
                    <th>Change Type</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>new</code></td>
                    <td>Course added to database from external feed</td>
                </tr>
                <tr>
                    <td><code>updated</code></td>
                    <td>One or more fields changed</td>
                </tr>
                <tr>
                    <td><code>reactivated</code></td>
                    <td>Previously inactive course re-appeared in feed</td>
                </tr>
                <tr>
                    <td><code>removed_from_hub</code></td>
                    <td>Course no longer in feed, HUBInclude set to No</td>
                </tr>
                <tr>
                    <td><code>persisted_inactive</code></td>
                    <td>Course removed but marked for persistence</td>
                </tr>
            </tbody>
        </table>
    </section>

    <section id="patterns" class="section">
        <h2>9. Code Patterns & Standards</h2>

        <h3>9.1 Coding Standards</h3>
        <table>
            <thead>
                <tr>
                    <th>Aspect</th>
                    <th>Standard</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>PHP Version</td>
                    <td>8.2+ (tested on 8.2, 8.3, 8.4)</td>
                </tr>
                <tr>
                    <td>Database Access</td>
                    <td>PDO with prepared statements exclusively</td>
                </tr>
                <tr>
                    <td>Error Mode</td>
                    <td>PDO::ERRMODE_EXCEPTION</td>
                </tr>
                <tr>
                    <td>Fetch Mode</td>
                    <td>PDO::FETCH_ASSOC</td>
                </tr>
                <tr>
                    <td>Frontend</td>
                    <td>Bootstrap 5.3+ (CDN), vanilla JavaScript</td>
                </tr>
                <tr>
                    <td>Font</td>
                    <td>BC Sans (government standard)</td>
                </tr>
                <tr>
                    <td>Autoloading</td>
                    <td>PSR-4 via Composer</td>
                </tr>
            </tbody>
        </table>

        <h3>9.2 File Organization</h3>
        <pre><code><span class="comment">// Standard page structure</span>
&lt;?php
<span class="keyword">require_once</span> <span class="string">'db_connection.php'</span>;    <span class="comment">// Database connection</span>
<span class="keyword">require_once</span> <span class="string">'auth.php'</span>;             <span class="comment">// Authentication + CSRF</span>

requireAuth();                       <span class="comment">// Enforce login</span>
<span class="comment">// requireAuth(true); for super-user-only pages</span>

<span class="comment">// Business logic here</span>
$stmt = $db-&gt;prepare(<span class="string">"SELECT * FROM courses WHERE Status = ?"</span>);
$stmt-&gt;execute([<span class="string">'Active'</span>]);
$courses = $stmt-&gt;fetchAll();

<span class="keyword">require_once</span> <span class="string">'includes/header.php'</span>;  <span class="comment">// HTML header, nav</span>
?&gt;

&lt;!-- Page content --&gt;

&lt;?php <span class="keyword">require_once</span> <span class="string">'includes/footer.php'</span>; ?&gt;</code></pre>

        <h3>9.3 No Framework Philosophy</h3>
        <div class="warning-box">
            <strong>Intentional Design Choice:</strong> lsapp5000 deliberately avoids frameworks (Laravel, Symfony) to:
            <ul>
                <li>Eliminate dependency management burden</li>
                <li>Avoid framework upgrade cycles</li>
                <li>Maintain simplicity for 8+ year lifespan</li>
                <li>Enable any PHP developer to maintain the code</li>
                <li>Match the legacy system's zero-dependency philosophy</li>
            </ul>
            This is appropriate for an administrative tool with a small user base and minimal complexity.
        </div>
    </section>

    <section id="performance" class="section">
        <h2>10. Performance Considerations</h2>

        <h3>10.1 Query Optimization</h3>
        <table>
            <thead>
                <tr>
                    <th>Optimization</th>
                    <th>Implementation</th>
                    <th>Impact</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Indexed Queries</td>
                    <td>22 indexes on FK and common filters</td>
                    <td>O(log n) vs O(n) lookups</td>
                </tr>
                <tr>
                    <td>FTS5 Search</td>
                    <td>Dedicated virtual table with triggers</td>
                    <td>Sub-millisecond full-text search</td>
                </tr>
                <tr>
                    <td>Session Caching</td>
                    <td>User data cached after first lookup</td>
                    <td>1 query per session vs per page</td>
                </tr>
                <tr>
                    <td>Prepared Statements</td>
                    <td>PDO prepared statements cached</td>
                    <td>Query plan reuse</td>
                </tr>
                <tr>
                    <td>Selective Fetching</td>
                    <td>Only needed columns in SELECT</td>
                    <td>Reduced memory, faster transfer</td>
                </tr>
            </tbody>
        </table>

        <h3>10.2 Comparison: CSV vs SQLite Performance</h3>
        <div class="comparison-grid">
            <div class="comparison-card bad">
                <h4>Legacy CSV Approach</h4>
                <ul>
                    <li><strong>Find course by ID:</strong> Full file scan of courses.csv</li>
                    <li><strong>Classes for course:</strong> Full file scan of classes.csv</li>
                    <li><strong>Search courses:</strong> Load all, filter in PHP</li>
                    <li><strong>Join data:</strong> Multiple file loads, manual merge</li>
                    <li><strong>Complexity:</strong> O(n) per query, O(n*m) for joins</li>
                </ul>
            </div>
            <div class="comparison-card good">
                <h4>lsapp5000 SQLite</h4>
                <ul>
                    <li><strong>Find course by ID:</strong> Index seek, O(1)</li>
                    <li><strong>Classes for course:</strong> Index seek, O(log n)</li>
                    <li><strong>Search courses:</strong> FTS5, O(log n)</li>
                    <li><strong>Join data:</strong> Query optimizer, indexed joins</li>
                    <li><strong>Complexity:</strong> O(log n) or O(1) for most queries</li>
                </ul>
            </div>
        </div>
    </section>

    <section id="maintenance" class="section">
        <h2>11. Long-Term Maintenance</h2>

        <h3>11.1 Maintenance Advantages</h3>
        <div class="benefit-list">
            <div class="benefit-item">
                <h4>Zero External Dependencies</h4>
                <p>No packages to update, no security patches to apply (beyond PHP itself). SQLite is part of PHP core.</p>
            </div>
            <div class="benefit-item">
                <h4>Comprehensive Documentation</h4>
                <p>README, CLAUDE.md, TESTING.md, security audit report, sync documentation - all in the repository.</p>
            </div>
            <div class="benefit-item">
                <h4>80% Code Reduction</h4>
                <p>56 files vs 293 files. Less code = fewer bugs = less maintenance.</p>
            </div>
            <div class="benefit-item">
                <h4>Automated Testing</h4>
                <p>PHPUnit tests catch regressions. CI/CD validates across PHP versions.</p>
            </div>
            <div class="benefit-item">
                <h4>Simple Backup</h4>
                <p>Copy one database file. No dump scripts, no export/import complexity.</p>
            </div>
            <div class="benefit-item">
                <h4>Portable</h4>
                <p>Application folder is self-contained. Move to new server by copying directory.</p>
            </div>
        </div>

        <h3>11.2 PHP Version Compatibility</h3>
        <p>Tested and validated on:</p>
        <ul>
            <li>PHP 8.2 (current LTS)</li>
            <li>PHP 8.3 (current stable)</li>
            <li>PHP 8.4 (latest)</li>
        </ul>
        <p>The codebase uses no deprecated features and should remain compatible through PHP 9.x based on current roadmaps.</p>

        <h3>11.3 Upgrade Path</h3>
        <p>When PHP versions change:</p>
        <ol>
            <li>Update CI/CD matrix to include new version</li>
            <li>Run test suite</li>
            <li>Address any deprecation warnings</li>
            <li>Deploy</li>
        </ol>
        <p>No framework-specific migration guides, no dependency conflicts, no breaking API changes from third-party packages.</p>
    </section>

    <section id="cicd" class="section">
        <h2>12. CI/CD Integration</h2>

        <h3>12.1 GitHub Actions Workflow</h3>
        <pre><code><span class="keyword">name</span>: Tests
<span class="keyword">on</span>:
  <span class="keyword">push</span>:
    branches: [main, develop]
  <span class="keyword">pull_request</span>:
    branches: [main]

<span class="keyword">jobs</span>:
  <span class="keyword">test</span>:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: [<span class="string">'8.2'</span>, <span class="string">'8.3'</span>, <span class="string">'8.4'</span>]

    <span class="keyword">steps</span>:
      - <span class="keyword">uses</span>: actions/checkout@v4

      - <span class="keyword">name</span>: Setup PHP
        <span class="keyword">uses</span>: shivammathur/setup-php@v2
        <span class="keyword">with</span>:
          php-version: ${{ matrix.php-version }}
          extensions: pdo_sqlite, mbstring
          coverage: xdebug

      - <span class="keyword">name</span>: Install dependencies
        <span class="keyword">run</span>: composer install --prefer-dist --no-progress

      - <span class="keyword">name</span>: Run tests
        <span class="keyword">run</span>: composer test</code></pre>

        <h3>12.2 Deployment Process</h3>
        <p>Recommended deployment workflow:</p>
        <ol>
            <li>Push changes to <code>develop</code> branch</li>
            <li>CI runs tests across PHP versions</li>
            <li>Create PR to <code>main</code> when ready</li>
            <li>Merge after review and test pass</li>
            <li>Deploy <code>main</code> to production (rsync or git pull)</li>
        </ol>

        <h3>12.3 Backup Strategy</h3>
        <pre><code><span class="comment"># Daily backup (cron job)</span>
<span class="number">0 2</span> * * * cp /var/www/lsapp5000/course_management.db \
    /backups/lsapp5000/course_management_$(date +\%Y\%m\%d).db

<span class="comment"># Retain 30 days</span>
find /backups/lsapp5000/ -name <span class="string">"*.db"</span> -mtime +<span class="number">30</span> -delete</code></pre>
    </section>

    <footer>
        <p>This technical addendum accompanies the Executive Report for LSApp Modernization.</p>
        <p>Generated January 9, 2026 | For Technical Leadership Review</p>
    </footer>
</body>
</html>
